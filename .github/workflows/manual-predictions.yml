name: Manual Predictions Trigger

on:
  workflow_dispatch:
    inputs:
      symbols_to_predict:
        description: 'Symbols (comma-separated, or leave empty for default)'
        required: false
        default: 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD'

env:
  API_BASE_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL || 'https://trading-models.vercel.app' }}

jobs:
  manual-predictions:
    name: Generate Predictions (Manual Trigger)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Display configuration
        run: |
          echo "üéØ API Base URL: ${{ env.API_BASE_URL }}"
          echo "üìä Symbols: ${{ github.event.inputs.symbols_to_predict || 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD' }}"
      
      - name: Predict BTC/USDT
        run: |
          echo "ü™ô Processing BTC/USDT..."
          
          echo "  üì• Fetching market data..."
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=BTC%2FUSDT" --max-time 30)
          
          if [ $? -ne 0 ]; then
            echo "  ‚ùå Failed to fetch data"
            exit 0
          fi
          
          echo "$DATA_RESPONSE" | jq empty 2>/dev/null || {
            echo "  ‚ùå Invalid JSON response"
            exit 0
          }
          
          SUCCESS=$(echo "$DATA_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$DATA_RESPONSE" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            -d "{\"symbol\":\"BTC/USDT\",\"data\":$DATA_PAYLOAD}")
          
          PRED_CLASS=$(echo "$PRED_RESPONSE" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_RESPONSE" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_RESPONSE" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      - name: Predict ETH/USDT
        run: |
          echo "ü™ô Processing ETH/USDT..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=ETH%2FUSDT" --max-time 30)
          
          if [ $? -ne 0 ]; then
            echo "  ‚ùå Failed to fetch data"
            exit 0
          fi
          
          echo "$DATA_RESPONSE" | jq empty 2>/dev/null || {
            echo "  ‚ùå Invalid JSON response"
            exit 0
          }
          
          SUCCESS=$(echo "$DATA_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$DATA_RESPONSE" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            -d "{\"symbol\":\"ETH/USDT\",\"data\":$DATA_PAYLOAD}")
          
          PRED_CLASS=$(echo "$PRED_RESPONSE" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_RESPONSE" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_RESPONSE" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      - name: Predict SOL/USDT
        run: |
          echo "ü™ô Processing SOL/USDT..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=SOL%2FUSDT" --max-time 30)
          
          if [ $? -ne 0 ]; then
            echo "  ‚ùå Failed to fetch data"
            exit 0
          fi
          
          echo "$DATA_RESPONSE" | jq empty 2>/dev/null || {
            echo "  ‚ùå Invalid JSON response"
            exit 0
          }
          
          SUCCESS=$(echo "$DATA_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$DATA_RESPONSE" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            -d "{\"symbol\":\"SOL/USDT\",\"data\":$DATA_PAYLOAD}")
          
          PRED_CLASS=$(echo "$PRED_RESPONSE" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_RESPONSE" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_RESPONSE" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      - name: Predict EURUSD
        run: |
          echo "üí± Processing EURUSD..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=EURUSD" --max-time 45)
          
          if [ $? -ne 0 ]; then
            echo "  ‚ùå Failed to fetch data"
            exit 0
          fi
          
          echo "$DATA_RESPONSE" | jq empty 2>/dev/null || {
            echo "  ‚ùå Invalid JSON response"
            exit 0
          }
          
          SUCCESS=$(echo "$DATA_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$DATA_RESPONSE" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-forex" \
            -H "Content-Type: application/json" \
            -d "{\"pair\":\"EURUSD\",\"data\":$DATA_PAYLOAD}")
          
          PRED_CLASS=$(echo "$PRED_RESPONSE" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_RESPONSE" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_RESPONSE" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      - name: Predict GBPUSD
        run: |
          echo "üí± Processing GBPUSD..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=GBPUSD" --max-time 45)
          
          if [ $? -ne 0 ]; then
            echo "  ‚ùå Failed to fetch data"
            exit 0
          fi
          
          echo "$DATA_RESPONSE" | jq empty 2>/dev/null || {
            echo "  ‚ùå Invalid JSON response"
            exit 0
          }
          
          SUCCESS=$(echo "$DATA_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$DATA_RESPONSE" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-forex" \
            -H "Content-Type: application/json" \
            -d "{\"pair\":\"GBPUSD\",\"data\":$DATA_PAYLOAD}")
          
          PRED_CLASS=$(echo "$PRED_RESPONSE" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_RESPONSE" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_RESPONSE" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      - name: Verify stored predictions
        run: |
          echo "üîç Checking database..."
          
          VERIFY_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/get-predictions?limit=5")
          
          TOTAL=$(echo "$VERIFY_RESPONSE" | jq -r '.pagination.total_count // 0')
          
          echo "‚úÖ Total predictions in database: $TOTAL"
          
          if [ "$TOTAL" -gt 0 ]; then
            echo ""
            echo "üìä Latest predictions:"
            echo "$VERIFY_RESPONSE" | jq -r '.data[] | "  - \(.symbol // .pair): \(.class) (\(.confidence * 100 | floor)%)"'
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================================================"
          echo "‚úÖ MANUAL PREDICTIONS COMPLETE"
          echo "========================================================================"
          echo ""
          echo "üåê Dashboard: ${{ env.API_BASE_URL }}"
          echo ""
          echo "Refresh your dashboard to see the new predictions!"
          echo ""