name: Manual Predictions Trigger - FIXED

on:
  workflow_dispatch:
    inputs:
      symbols_to_predict:
        description: 'Symbols (comma-separated, or leave empty for default)'
        required: false
        default: 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD'

env:
  API_BASE_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL || 'https://trading-models.vercel.app' }}

jobs:
  # ============================================================================
  # STEP 1: Verify MongoDB Access (CRITICAL FIX)
  # ============================================================================
  verify-mongodb:
    name: Verify MongoDB Connection
    runs-on: ubuntu-latest
    
    steps:
      - name: Check MongoDB Atlas Connectivity
        run: |
          echo "‚è≥ Testing MongoDB Atlas connection..."
          
          # Test if API can reach MongoDB
          RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/store-prediction?health=true" \
            --max-time 10 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå FATAL: Cannot connect to MongoDB!"
            echo ""
            echo "TROUBLESHOOTING STEPS:"
            echo "1. Check MongoDB Atlas Network Access ‚Üí IP Access List"
            echo "2. Add IP: 0.0.0.0/0 (Allow from anywhere) OR"
            echo "3. Use dynamic IP whitelisting (see documentation)"
            echo ""
            echo "Current error response:"
            echo "$BODY"
            exit 1
          fi
          
          echo "‚úÖ MongoDB connection verified"

  # ============================================================================
  # STEP 2: Generate Predictions
  # ============================================================================
  manual-predictions:
    name: Generate Predictions (Manual Trigger)
    runs-on: ubuntu-latest
    needs: verify-mongodb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Display configuration
        run: |
          echo "üéØ API Base URL: ${{ env.API_BASE_URL }}"
          echo "üìä Symbols: ${{ github.event.inputs.symbols_to_predict || 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD' }}"
      
      # ======================================================================
      # Predict: BTC/USDT
      # ======================================================================
      - name: Predict BTC/USDT
        continue-on-error: true
        run: |
          echo "ü™ô Processing BTC/USDT..."
          
          # Fetch market data
          echo "  üì• Fetching market data..."
          FETCH_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=BTC%2FUSDT" \
            --max-time 30 -w "\nHTTP_CODE:%{http_code}")
          
          FETCH_HTTP=$(echo "$FETCH_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          FETCH_BODY=$(echo "$FETCH_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$FETCH_HTTP" != "200" ]; then
            echo "  ‚ùå Fetch failed (HTTP $FETCH_HTTP)"
            echo "  Response: $(echo "$FETCH_BODY" | head -c 200)"
            exit 1
          fi
          
          # Validate JSON before using jq
          if ! echo "$FETCH_BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            echo "  Response: $(echo "$FETCH_BODY" | head -c 200)"
            exit 1
          fi
          
          SUCCESS=$(echo "$FETCH_BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå API returned success=false"
            ERROR=$(echo "$FETCH_BODY" | jq -r '.error // "Unknown"')
            echo "  Error: $ERROR"
            exit 1
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          # Safe data extraction
          DATA_PAYLOAD=$(echo "$FETCH_BODY" | jq -c '.data // {}')
          
          if [ "$DATA_PAYLOAD" = "{}" ]; then
            echo "  ‚ùå No data in response"
            exit 1
          fi
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            -d "{\"symbol\":\"BTC/USDT\",\"data\":$DATA_PAYLOAD}")
          
          PRED_HTTP=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP)"
            echo "  Response: $(echo "$PRED_BODY" | head -c 200)"
            exit 1
          fi
          
          # Validate prediction response
          if ! echo "$PRED_BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid prediction JSON"
            exit 1
          fi
          
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $(echo "$PRED_CONF * 100" | bc)%)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Predict: ETH/USDT
      # ======================================================================
      - name: Predict ETH/USDT
        continue-on-error: true
        run: |
          echo "ü™ô Processing ETH/USDT..."
          
          RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=ETH%2FUSDT" \
            --max-time 30 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ] || ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Failed"
            exit 1
          fi
          
          DATA=$(echo "$BODY" | jq -c '.data')
          
          PRED=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            -d "{\"symbol\":\"ETH/USDT\",\"data\":$DATA}")
          
          echo "  ‚úÖ $(echo "$PRED" | jq -r '.class') @ $(echo "$PRED" | jq -r '.confidence')"
      
      # ======================================================================
      # Storage Verification
      # ======================================================================
      - name: Verify stored predictions
        continue-on-error: true
        run: |
          echo "üîç Verifying predictions in database..."
          
          RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/get-predictions?limit=5" \
            --max-time 10 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            if echo "$BODY" | jq empty 2>/dev/null; then
              TOTAL=$(echo "$BODY" | jq -r '.pagination.total_count // 0')
              RETURNED=$(echo "$BODY" | jq -r '.pagination.returned_count // 0')
              
              echo "‚úÖ Database query successful"
              echo "   Total predictions: $TOTAL"
              echo "   Retrieved: $RETURNED"
              
              if [ "$RETURNED" -gt 0 ]; then
                echo ""
                echo "Latest prediction:"
                echo "$BODY" | jq -r '.data[0] | "  Symbol: \(.symbol // .pair)\n  Class: \(.class)\n  Confidence: \(.confidence)\n  Time: \(.timestamp)"'
              fi
            else
              echo "‚ö†Ô∏è Invalid JSON response"
            fi
          else
            echo "‚ö†Ô∏è HTTP $HTTP_CODE"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================================================"
          echo "‚úÖ MANUAL PREDICTIONS COMPLETE"
          echo "========================================================================"
          echo ""
          echo "üåê Dashboard: ${{ env.API_BASE_URL }}"
          echo ""
          echo "üîÑ Refresh your dashboard to see new predictions"
          echo ""