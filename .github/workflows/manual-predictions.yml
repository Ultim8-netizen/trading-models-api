name: Manual Predictions Trigger

on:
  workflow_dispatch:
    inputs:
      symbols_to_predict:
        description: 'Symbols (comma-separated, or leave empty for default)'
        required: false
        default: 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD'

env:
  API_BASE_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL || 'https://trading-models.vercel.app' }}

jobs:
  manual-predictions:
    name: Generate Predictions (Manual Trigger)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Display configuration
        run: |
          echo "üéØ API Base URL: ${{ env.API_BASE_URL }}"
          echo "üìä Symbols: ${{ github.event.inputs.symbols_to_predict || 'BTC/USDT,ETH/USDT,SOL/USDT,EURUSD,GBPUSD' }}"
      
      # ======================================================================
      # Predict: BTC/USDT
      # ======================================================================
      - name: Predict BTC/USDT
        continue-on-error: true
        run: |
          echo "ü™ô Processing BTC/USDT..."
          
          # Fetch data
          echo "  üì• Fetching market data..."
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=BTC%2FUSDT" --max-time 30 -w "\nHTTP_CODE:%{http_code}")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$DATA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$DATA_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Failed to fetch data (HTTP $HTTP_CODE)"
            echo "  Response: $BODY" | head -c 200
            exit 0
          fi
          
          # Check if data is valid JSON
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            echo "  Response preview: $BODY" | head -c 200
            exit 0
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            ERROR_MSG=$(echo "$BODY" | jq -r '.error // "Unknown error"')
            echo "  ‚ùå Data fetch failed: $ERROR_MSG"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          # Extract data payload
          DATA_PAYLOAD=$(echo "$BODY" | jq -c '.data')
          
          # Run prediction
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            --data-binary @- <<EOF
{
  "symbol": "BTC/USDT",
  "data": $DATA_PAYLOAD
}
EOF
          )
          
          # Extract HTTP code
          PRED_HTTP_CODE=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP_CODE)"
            exit 0
          fi
          
          # Parse prediction result
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Predict: ETH/USDT
      # ======================================================================
      - name: Predict ETH/USDT
        continue-on-error: true
        run: |
          echo "ü™ô Processing ETH/USDT..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=ETH%2FUSDT" --max-time 30 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$DATA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$DATA_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Failed to fetch data (HTTP $HTTP_CODE)"
            exit 0
          fi
          
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            exit 0
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$BODY" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            --data-binary @- <<EOF
{
  "symbol": "ETH/USDT",
  "data": $DATA_PAYLOAD
}
EOF
          )
          
          PRED_HTTP_CODE=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP_CODE)"
            exit 0
          fi
          
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Predict: SOL/USDT
      # ======================================================================
      - name: Predict SOL/USDT
        continue-on-error: true
        run: |
          echo "ü™ô Processing SOL/USDT..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=SOL%2FUSDT" --max-time 30 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$DATA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$DATA_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Failed to fetch data (HTTP $HTTP_CODE)"
            exit 0
          fi
          
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            exit 0
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$BODY" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            --data-binary @- <<EOF
{
  "symbol": "SOL/USDT",
  "data": $DATA_PAYLOAD
}
EOF
          )
          
          PRED_HTTP_CODE=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP_CODE)"
            exit 0
          fi
          
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Predict: EURUSD
      # ======================================================================
      - name: Predict EURUSD
        continue-on-error: true
        run: |
          echo "üí± Processing EURUSD..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=EURUSD" --max-time 45 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$DATA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$DATA_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Failed to fetch data (HTTP $HTTP_CODE)"
            exit 0
          fi
          
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            exit 0
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$BODY" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-forex" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            --data-binary @- <<EOF
{
  "pair": "EURUSD",
  "data": $DATA_PAYLOAD
}
EOF
          )
          
          PRED_HTTP_CODE=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP_CODE)"
            exit 0
          fi
          
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Predict: GBPUSD
      # ======================================================================
      - name: Predict GBPUSD
        continue-on-error: true
        run: |
          echo "üí± Processing GBPUSD..."
          
          DATA_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?symbol=GBPUSD" --max-time 45 -w "\nHTTP_CODE:%{http_code}")
          
          HTTP_CODE=$(echo "$DATA_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$DATA_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Failed to fetch data (HTTP $HTTP_CODE)"
            exit 0
          fi
          
          if ! echo "$BODY" | jq empty 2>/dev/null; then
            echo "  ‚ùå Invalid JSON response"
            exit 0
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "  ‚ùå Data fetch failed"
            exit 0
          fi
          
          echo "  ‚úÖ Data fetched successfully"
          
          DATA_PAYLOAD=$(echo "$BODY" | jq -c '.data')
          
          echo "  ü§ñ Running prediction..."
          PRED_RESPONSE=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/predict-forex" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            -w "\nHTTP_CODE:%{http_code}" \
            --data-binary @- <<EOF
{
  "pair": "GBPUSD",
  "data": $DATA_PAYLOAD
}
EOF
          )
          
          PRED_HTTP_CODE=$(echo "$PRED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          PRED_BODY=$(echo "$PRED_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$PRED_HTTP_CODE" != "200" ]; then
            echo "  ‚ùå Prediction failed (HTTP $PRED_HTTP_CODE)"
            exit 0
          fi
          
          PRED_CLASS=$(echo "$PRED_BODY" | jq -r '.class // "UNKNOWN"')
          PRED_CONF=$(echo "$PRED_BODY" | jq -r '.confidence // 0')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored // false')
          
          echo "  ‚úÖ Prediction: $PRED_CLASS (Confidence: $PRED_CONF)"
          echo "  üíæ Stored: $STORED"
      
      # ======================================================================
      # Verification
      # ======================================================================
      - name: Verify stored predictions
        continue-on-error: true
        run: |
          echo "üîç Checking database..."
          
          VERIFY_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/get-predictions?limit=5" --max-time 10 -w "\nHTTP_CODE:%{http_code}")
          
          # Extract HTTP code
          HTTP_CODE=$(echo "$VERIFY_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$VERIFY_RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è  API returned HTTP $HTTP_CODE"
            echo "Response preview:"
            echo "$BODY" | head -c 300
            exit 0
          fi
          
          # Check if response is valid JSON
          if echo "$BODY" | jq empty 2>/dev/null; then
            TOTAL=$(echo "$BODY" | jq -r '.pagination.total_count // 0')
            
            echo "‚úÖ Total predictions in database: $TOTAL"
            
            if [ "$TOTAL" -gt 0 ]; then
              echo ""
              echo "üìä Latest predictions:"
              echo "$BODY" | jq -r '.data[] | "  - \(.symbol // .pair): \(.class) (\(.confidence * 100 | floor)%)"' 2>/dev/null || echo "  (Could not parse prediction details)"
            else
              echo "‚ö†Ô∏è  No predictions found in database"
            fi
          else
            echo "‚ö†Ô∏è  Could not verify database (API returned invalid response)"
            echo "Response preview (first 300 chars):"
            echo "$BODY" | head -c 300
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================================================"
          echo "‚úÖ MANUAL PREDICTIONS COMPLETE"
          echo "========================================================================"
          echo ""
          echo "üåê Dashboard: ${{ env.API_BASE_URL }}"
          echo ""
          echo "Refresh your dashboard to see the new predictions!"
          echo ""