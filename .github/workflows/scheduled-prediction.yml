name: Scheduled Predictions (Every 4 Hours) - FIXED

on:
  schedule:
    # Run every 4 hours (0, 4, 8, 12, 16, 20 UTC)
    - cron: '0 */4 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test with single symbol only'
        required: false
        default: 'false'

# Environment variables configuration
env:
  # IMPORTANT: Set this in GitHub Secrets (Settings > Secrets > Actions)
  # Format: https://your-actual-app-name.vercel.app (NO trailing slash)
  API_BASE_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL || 'https://trading-models.vercel.app' }}

jobs:
  # ============================================================================
  # HEALTH CHECK JOB (runs first to verify API is up)
  # ============================================================================
  health-check:
    name: Verify API Health
    runs-on: ubuntu-latest
    outputs:
      api_healthy: ${{ steps.health.outputs.healthy }}
    
    steps:
      - name: Check API Health
        id: health
        run: |
          echo "ðŸ¥ Checking API health at ${{ env.API_BASE_URL }}..."
          
          # Test with retry logic
          for i in {1..3}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "${{ env.API_BASE_URL }}/api/get-predictions?health=true" \
              --max-time 10)
            
            echo "Attempt $i: HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… API is healthy"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            
            sleep 5
          done
          
          echo "âŒ API health check failed after 3 attempts"
          echo "healthy=false" >> "$GITHUB_OUTPUT"
          exit 1

  # ============================================================================
  # CRYPTO PREDICTIONS
  # ============================================================================
  predict-crypto:
    name: Crypto Predictions
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.api_healthy == 'true'
    
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        symbol:
          - 'BTC/USDT'
          - 'ETH/USDT'
          - 'SOL/USDT'
          - 'ETC/USDT'
          - 'DOGE/USDT'
          - 'ADA/USDT'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Fetch market data for ${{ matrix.symbol }}
        id: fetch_data
        run: |
          set -euo pipefail
          
          echo "ðŸ”„ Fetching real market data for ${{ matrix.symbol }}..."
          
          # Properly URL-encode the symbol
          ENCODED_SYMBOL=$(echo "${{ matrix.symbol }}" | sed 's/\//%2F/g')
          FETCH_URL="${{ env.API_BASE_URL }}/api/fetch-data?symbol=${ENCODED_SYMBOL}"
          
          echo "ðŸ“ URL: $FETCH_URL"
          
          # Fetch with detailed error handling
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" "$FETCH_URL" --max-time 30)
          
          # Split response and status code
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n 1)
          
          echo "HTTP Status: $HTTP_CODE"
          
          # Check status code
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Data fetch failed with status $HTTP_CODE"
            echo "Response body (first 500 chars):"
            echo "$HTTP_BODY" | head -c 500
            exit 1
          fi
          
          # Validate JSON before parsing
          if ! echo "$HTTP_BODY" | jq empty 2>/dev/null; then
            echo "âŒ Response is not valid JSON"
            echo "Response (first 500 chars):"
            echo "$HTTP_BODY" | head -c 500
            exit 1
          fi
          
          # Save data to file
          echo "$HTTP_BODY" > market_data.json
          
          # Validate data
          DATA_POINTS=$(echo "$HTTP_BODY" | jq -r '.dataPoints // 0')
          SUCCESS=$(echo "$HTTP_BODY" | jq -r '.success // false')
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ API returned success=false"
            ERROR_MSG=$(echo "$HTTP_BODY" | jq -r '.error // "Unknown error"')
            echo "Error: $ERROR_MSG"
            exit 1
          fi
          
          if [ "$DATA_POINTS" -lt 50 ]; then
            echo "âŒ Insufficient data points: $DATA_POINTS (need at least 50)"
            exit 1
          fi
          
          echo "âœ… Fetched $DATA_POINTS data points"
      
      - name: Run prediction for ${{ matrix.symbol }}
        id: predict
        run: |
          set -euo pipefail
          
          echo "ðŸ¤– Running prediction for ${{ matrix.symbol }}..."
          
          # Read fetched data
          DATA=$(jq -c '.data' market_data.json)
          
          # Create properly formatted JSON payload
          PAYLOAD=$(jq -n \
            --arg symbol "${{ matrix.symbol }}" \
            --argjson data "$DATA" \
            '{symbol: $symbol, data: $data}')
          
          # Send prediction request
          PREDICTION_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ env.API_BASE_URL }}/api/predict-crypto" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Scheduler/1.0" \
            -d "$PAYLOAD")
          
          # Split response and status code
          PRED_BODY=$(echo "$PREDICTION_RESPONSE" | head -n -1)
          PRED_CODE=$(echo "$PREDICTION_RESPONSE" | tail -n 1)
          
          echo "HTTP Status: $PRED_CODE"
          
          if [ "$PRED_CODE" != "200" ]; then
            echo "âŒ Prediction failed with status $PRED_CODE"
            echo "Response (first 500 chars):"
            echo "$PRED_BODY" | head -c 500
            exit 1
          fi
          
          # Validate JSON
          if ! echo "$PRED_BODY" | jq empty 2>/dev/null; then
            echo "âŒ Prediction response is not valid JSON"
            exit 1
          fi
          
          # Parse results
          SUCCESS=$(echo "$PRED_BODY" | jq -r '.success // false')
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Prediction API returned success=false"
            ERROR_MSG=$(echo "$PRED_BODY" | jq -r '.error // "Unknown error"')
            echo "Error: $ERROR_MSG"
            exit 1
          fi
          
          CLASS=$(echo "$PRED_BODY" | jq -r '.class')
          CONFIDENCE=$(echo "$PRED_BODY" | jq -r '.confidence')
          STORED=$(echo "$PRED_BODY" | jq -r '.stored')
          MODELS=$(echo "$PRED_BODY" | jq -r '.models_used')
          TIME=$(echo "$PRED_BODY" | jq -r '.inference_time_ms')
          
          echo "âœ… Prediction complete:"
          echo "   Class: $CLASS"
          echo "   Confidence: $CONFIDENCE"
          echo "   Models: $MODELS"
          echo "   Time: ${TIME}ms"
          echo "   Stored: $STORED"
          
          # Set outputs for summary
          {
            echo "class=$CLASS"
            echo "confidence=$CONFIDENCE"
            echo "stored=$STORED"
          } >> "$GITHUB_OUTPUT"
      
      - name: Cleanup
        if: always()
        run: rm -f market_data.json
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.predict.outcome }}" == "success" ]; then
            {
              echo "### âœ… ${{ matrix.symbol }}"
              echo "- **Prediction**: ${{ steps.predict.outputs.class }}"
              echo "- **Confidence**: ${{ steps.predict.outputs.confidence }}"
              echo "- **Stored**: ${{ steps.predict.outputs.stored }}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### âŒ ${{ matrix.symbol }} - FAILED"
              echo "Check logs for details"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

  # ============================================================================
  # FOREX PREDICTIONS (with quota management)
  # ============================================================================
  predict-forex:
    name: Forex Predictions
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.api_healthy == 'true'
    
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        pair:
          - 'EURUSD'
          - 'GBPJPY'
          - 'USDJPY'
          - 'GBPUSD'
          - 'AUDUSD'
          - 'USDCAD'
          - 'USDCHF'
          - 'EURAUD'
          - 'NZDUSD'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check Twelve Data quota
        id: check_quota
        run: |
          echo "ðŸ“Š Checking Twelve Data quota..."
          
          HEALTH_RESPONSE=$(curl -s "${{ env.API_BASE_URL }}/api/fetch-data?health=true")
          
          # This endpoint should return quota info if implemented
          # For now, we proceed optimistically
          echo "skip=false" >> "$GITHUB_OUTPUT"
      
      - name: Fetch forex data for ${{ matrix.pair }}
        if: steps.check_quota.outputs.skip != 'true'
        id: fetch_data
        run: |
          set -euo pipefail
          
          echo "ðŸ”„ Fetching forex data for ${{ matrix.pair }}..."
          
          FETCH_URL="${{ env.API_BASE_URL }}/api/fetch-data?symbol=${{ matrix.pair }}"
          
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" "$FETCH_URL" --max-time 45)
          
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n 1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Data fetch failed with status $HTTP_CODE"
            exit 1
          fi
          
          # Validate JSON
          if ! echo "$HTTP_BODY" | jq empty 2>/dev/null; then
            echo "âŒ Response is not valid JSON"
            exit 1
          fi
          
          echo "$HTTP_BODY" > forex_data.json
          
          DATA_POINTS=$(echo "$HTTP_BODY" | jq -r '.dataPoints // 0')
          echo "âœ… Fetched $DATA_POINTS data points"
      
      - name: Run forex prediction for ${{ matrix.pair }}
        if: steps.check_quota.outputs.skip != 'true'
        id: predict
        run: |
          set -euo pipefail
          
          echo "ðŸ¤– Running forex prediction for ${{ matrix.pair }}..."
          
          # Read fetched data
          DATA=$(jq -c '.data' forex_data.json)
          
          # Create properly formatted JSON payload
          PAYLOAD=$(jq -n \
            --arg pair "${{ matrix.pair }}" \
            --argjson data "$DATA" \
            '{pair: $pair, data: $data}')
          
          # Send prediction request
          PREDICTION_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ env.API_BASE_URL }}/api/predict-forex" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          PRED_BODY=$(echo "$PREDICTION_RESPONSE" | head -n -1)
          PRED_CODE=$(echo "$PREDICTION_RESPONSE" | tail -n 1)
          
          if [ "$PRED_CODE" != "200" ]; then
            echo "âŒ Prediction failed"
            exit 1
          fi
          
          CLASS=$(echo "$PRED_BODY" | jq -r '.class')
          CONFIDENCE=$(echo "$PRED_BODY" | jq -r '.confidence')
          
          echo "âœ… Prediction: $CLASS ($CONFIDENCE)"
          
          {
            echo "class=$CLASS"
            echo "confidence=$CONFIDENCE"
          } >> "$GITHUB_OUTPUT"
      
      - name: Cleanup
        if: always()
        run: rm -f forex_data.json
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_quota.outputs.skip }}" == "true" ]; then
            echo "### âš ï¸ ${{ matrix.pair }} - SKIPPED (Low Quota)" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ steps.predict.outcome }}" == "success" ]; then
            {
              echo "### âœ… ${{ matrix.pair }}"
              echo "- **Prediction**: ${{ steps.predict.outputs.class }}"
              echo "- **Confidence**: ${{ steps.predict.outputs.confidence }}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### âŒ ${{ matrix.pair }} - FAILED" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ============================================================================
  # FINAL SUMMARY
  # ============================================================================
  summary:
    name: Prediction Summary
    runs-on: ubuntu-latest
    needs: [predict-crypto, predict-forex]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          {
            echo "## ðŸ“Š Scheduled Predictions Complete"
            echo ""
            echo "**Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Status"
            echo "- Crypto predictions: Check individual job results"
            echo "- Forex predictions: Check individual job results"
            echo ""
            echo "ðŸ” **View results**: ${{ env.API_BASE_URL }}"
          } >> "$GITHUB_STEP_SUMMARY"